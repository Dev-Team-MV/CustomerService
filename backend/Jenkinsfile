// Jenkinsfile para CustomerService - backend
// main → producción (puerto 5000), develop → desarrollo (puerto 5001)
// Tag de imagen: solo un ":" (ej. customerservice-backend:development-1)

pipeline {
    agent any

    environment {
        APP_DIR = 'backend'
        JWT_SECRET = 'supersecretkey123456789'
        TWILIO_PHONE_FROM = '+18327707897'
        GCS_PROJECT_ID = 'centurions-car-wash-442201'
        GCS_BUCKET_NAME = 'customer-service-7cc'
        GCS_MAKE_PUBLIC = 'false'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Set environment') {
            steps {
                script {
                    def branch = env.BRANCH_NAME ?: env.GIT_BRANCH?.replaceFirst('^origin/', '') ?: 'develop'
                    env.IS_PRODUCTION = (env.DEPLOY_ENV == 'production' || branch == 'main').toString()
                    env.ENVIRONMENT = (env.IS_PRODUCTION == 'true') ? 'production' : 'development'
                    env.CONTAINER_NAME = (env.IS_PRODUCTION == 'true') ? 'backend' : 'backend-dev'
                    env.APP_PORT = (env.IS_PRODUCTION == 'true') ? '5000' : '5001'
                    env.IMAGE_NAME = 'customerservice-backend'
                    // Tag con un solo ":" -> nombre:tag (ej. customerservice-backend:development-1)
                    env.IMAGE_TAG = "${env.ENVIRONMENT}-${env.BUILD_NUMBER}"
                    echo "Desplegando ambiente: ${env.ENVIRONMENT} (contenedor: ${env.CONTAINER_NAME}, puerto: ${env.APP_PORT}, imagen: ${env.IMAGE_NAME}:${env.IMAGE_TAG})"
                }
            }
        }

        stage('Install') {
            steps {
                dir(env.APP_DIR) {
                    sh '''#!/bin/bash
                        set -e
                        mkdir -p "${WORKSPACE}/.nvm"
                        export NVM_DIR="${WORKSPACE}/.nvm"
                        curl -sSf -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                        [ -s "$NVM_DIR/nvm.sh" ] && \\. "$NVM_DIR/nvm.sh"
                        nvm install 20
                        nvm use 20
                        npm ci
                    '''
                }
            }
        }

        stage('Build Docker') {
            steps {
                dir(env.APP_DIR) {
                    sh "docker build -t ${env.IMAGE_NAME}:${env.IMAGE_TAG} ."
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'twilio-account-sid', variable: 'TWILIO_ACCOUNT_SID'),
                        string(credentialsId: 'twilio-auth-token', variable: 'TWILIO_AUTH_TOKEN'),
                        string(credentialsId: 'gcs-credentials-json', variable: 'GCS_CREDENTIALS')
                    ]) {
                        sh "docker stop ${env.CONTAINER_NAME} 2>/dev/null || true"
                        sh "docker rm ${env.CONTAINER_NAME} 2>/dev/null || true"
                        sh '''
                            printf 'GCS_CREDENTIALS=%s\\n' "$GCS_CREDENTIALS" > "${WORKSPACE}/backend/gcs.env"
                            docker run -d \
                              --name ''' + env.CONTAINER_NAME + ''' \
                              --network deploy_app-network \
                              -p ''' + env.APP_PORT + ''':5000 \
                              -e NODE_ENV=''' + (env.IS_PRODUCTION == 'true' ? 'production' : 'development') + ''' \
                              -e PORT=5000 \
                              -e MONGODB_URI=mongodb+srv://customerservicemichelangelo_db_user:lRNMjO5qLRGD6csL@customerservice.mkutnlt.mongodb.net/customerservice \
                              -e JWT_SECRET=''' + env.JWT_SECRET + ''' \
                              -e TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID \
                              -e TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN \
                              -e TWILIO_PHONE_FROM=''' + env.TWILIO_PHONE_FROM + ''' \
                              -e GCS_PROJECT_ID=''' + env.GCS_PROJECT_ID + ''' \
                              -e GCS_BUCKET_NAME=''' + env.GCS_BUCKET_NAME + ''' \
                              -e GCS_MAKE_PUBLIC=''' + env.GCS_MAKE_PUBLIC + ''' \
                              --env-file "${WORKSPACE}/backend/gcs.env" \
                              --restart unless-stopped \
                              ''' + env.IMAGE_NAME + ':' + env.IMAGE_TAG + '''
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Backend desplegado (${env.ENVIRONMENT}) en http://localhost:${env.APP_PORT}"
        }
        failure {
            echo 'Falló el pipeline'
        }
    }
}
