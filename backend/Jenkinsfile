// Job independiente: solo backend. En Jenkins â†’ Script Path: backend/Jenkinsfile
// No requiere plugin Node.js: instala Node en el workspace con nvm. Requiere: curl, bash. Docker en el agente para Build Docker Image.
pipeline {
  agent any

  options {
    timeout(time: 15, unit: 'MINUTES')
  }

  environment {
    IMAGE_NAME = "customer-service-backend"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install & Test') {
      steps {
        dir('backend') {
          sh '''#!/bin/bash
            set -e
            mkdir -p "${WORKSPACE}/.nvm"
            export NVM_DIR="${WORKSPACE}/.nvm"
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
            [ -s "$NVM_DIR/nvm.sh" ] && \\. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            npm ci
            npm run test --if-present
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('backend') {
          sh 'docker build -t "${IMAGE_NAME}" .'
        }
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
