// Jenkinsfile para CustomerService - backend en backend/, puerto 5000
// Copia este archivo a la RAÍZ de tu repo como "Jenkinsfile" y haz commit + push

pipeline {
    agent any

    environment {
        IMAGE_NAME = 'customerservice-backend'
        CONTAINER_NAME = 'backend'
        APP_DIR = 'backend'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install & Test') {
            steps {
                script {
                    def workDir = "/workspace/${env.APP_DIR}"
                    sh "docker run --rm -v ${env.WORKSPACE}:/workspace -w ${workDir} node:20-alpine sh -c 'npm ci --omit=dev 2>/dev/null || npm install --omit=dev && (npm run test --if-present; true)'"
                }
            }
        }

        stage('Build Docker') {
            steps {
                dir(env.APP_DIR) {
                    sh "docker build -t ${env.IMAGE_NAME}:${env.BUILD_NUMBER} ."
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh "docker stop ${env.CONTAINER_NAME} 2>/dev/null || true"
                    sh "docker rm ${env.CONTAINER_NAME} 2>/dev/null || true"
                    sh """
                        docker run -d \
                          --name ${env.CONTAINER_NAME} \
                          --network deploy_app-network \
                          -p 5000:5000 \
                          -e NODE_ENV=production \
                          -e PORT=5000 \
                          -e MONGODB_URI=mongodb://mongo:27017/appdb \
                          --restart unless-stopped \
                          ${env.IMAGE_NAME}:${env.BUILD_NUMBER}
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Backend desplegado en http://localhost:5000'
        }
        failure {
            echo 'Falló el pipeline'
        }
    }
}
