// Jenkinsfile para CustomerService - backend en backend/, puerto 5000
// Copia este archivo a la RAÍZ de tu repo como "Jenkinsfile" y haz commit + push

pipeline {
    agent any

    environment {
        IMAGE_NAME = 'customerservice-backend'
        CONTAINER_NAME = 'backend'
        APP_DIR = 'backend'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install') {
            steps {
                dir(env.APP_DIR) {
                    sh '''#!/bin/bash
                        set -e
                        mkdir -p "${WORKSPACE}/.nvm"
                        export NVM_DIR="${WORKSPACE}/.nvm"
                        curl -sSf -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                        [ -s "$NVM_DIR/nvm.sh" ] && \\. "$NVM_DIR/nvm.sh"
                        nvm install 20
                        nvm use 20
                        npm ci
                    '''
                }
            }
        }

        stage('Build Docker') {
            steps {
                dir(env.APP_DIR) {
                    sh "docker build -t ${env.IMAGE_NAME}:${env.BUILD_NUMBER} ."
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh "docker stop ${env.CONTAINER_NAME} 2>/dev/null || true"
                    sh "docker rm ${env.CONTAINER_NAME} 2>/dev/null || true"
                    sh """
                        docker run -d \
                          --name ${env.CONTAINER_NAME} \
                          --network deploy_app-network \
                          -p 5000:5000 \
                          -e NODE_ENV=production \
                          -e PORT=5000 \
                          -e MONGODB_URI=mongodb+srv://customerservicemichelangelo_db_user:lRNMjO5qLRGD6csL@customerservice.mkutnlt.mongodb.net/customerservice \
                          --restart unless-stopped \
                          ${env.IMAGE_NAME}:${env.BUILD_NUMBER}
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Backend desplegado en http://localhost:5000'
        }
        failure {
            echo 'Falló el pipeline'
        }
    }
}
