// Job independiente: solo frontend. main → producción, develop → desarrollo.
// Requiere: curl, bash, Docker. Para dos despliegues crea 2 Jobs (rama main y rama develop).

pipeline {
  agent any

  options {
    timeout(time: 15, unit: 'MINUTES')
  }

  environment {
    VITE_API_URL = "https://apics.michelangelodelvalle.com/api"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Set environment') {
      steps {
        script {
          def branch = env.BRANCH_NAME ?: env.GIT_BRANCH?.replaceFirst('^origin/', '') ?: 'develop'
          env.IS_PRODUCTION = (env.DEPLOY_ENV == 'production' || branch == 'main').toString()
          env.ENVIRONMENT = (env.IS_PRODUCTION == 'true') ? 'production' : 'development'
          env.CONTAINER_NAME = (env.IS_PRODUCTION == 'true') ? 'frontend' : 'frontend-dev'
          env.APP_PORT = (env.IS_PRODUCTION == 'true') ? '5173' : '5174'
          env.IMAGE_NAME = "customer-service-frontend:${env.ENVIRONMENT}"
          if (env.IS_PRODUCTION != 'true') {
            env.VITE_API_URL = env.VITE_API_URL_DEV ?: 'http://localhost:5001/api'
          }
          echo "Desplegando ambiente: ${env.ENVIRONMENT} (contenedor: ${env.CONTAINER_NAME}, puerto: ${env.APP_PORT})"
        }
      }
    }

    stage('Install & Build') {
      steps {
        dir('frontend') {
          sh '''#!/bin/bash
            set -e
            mkdir -p "${WORKSPACE}/.nvm"
            export NVM_DIR="${WORKSPACE}/.nvm"
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
            [ -s "$NVM_DIR/nvm.sh" ] && \\. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            npm ci
            npm run build
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('frontend') {
          sh "docker build -t ${env.IMAGE_NAME}:${env.BUILD_NUMBER} --build-arg VITE_API_URL=${env.VITE_API_URL} ."
        }
      }
    }

    stage('Deploy') {
      steps {
        script {
          sh "docker stop ${env.CONTAINER_NAME} 2>/dev/null || true"
          sh "docker rm ${env.CONTAINER_NAME} 2>/dev/null || true"
          sh """
            docker run -d \
              --name ${env.CONTAINER_NAME} \
              -p ${env.APP_PORT}:80 \
              --restart unless-stopped \
              ${env.IMAGE_NAME}:${env.BUILD_NUMBER}
          """
        }
      }
    }
  }

  post {
    success {
      echo "Frontend desplegado (${env.ENVIRONMENT}) en http://localhost:${env.APP_PORT}"
    }
    always {
      cleanWs()
    }
  }
}
