// Jobs: CustomerService-Frontend-Develop → apicsdev | CustomerService-Frontend-Production → apics
// Front dev = devcustomerservice.michelangelodelvalle.com → backend apicsdev.michelangelodelvalle.com
// Front pdn = customerservice.michelangelodelvalle.com → backend apics.michelangelodelvalle.com
pipeline {
  agent any

  options {
    timeout(time: 15, unit: 'MINUTES')
  }

  // No definir VITE_API_URL aquí: se fija en "Set environment" según el Job (Develop → apicsdev, Production → apics)
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Set environment') {
      steps {
        script {
          def branch = env.BRANCH_NAME ?: env.GIT_BRANCH?.replaceFirst('^origin/', '') ?: 'develop'
          def jobName = (env.JOB_NAME ?: '').toLowerCase()
          // Ambiente por nombre del Job: Develop job → siempre API dev (apicsdev); Production job → API pdn (apics)
          def isProdJob = jobName.contains('production') || jobName.contains('prod') || jobName.contains('pdn')
          def isDevJob = jobName.contains('development') || jobName.contains('dev') || jobName.contains('develop')
          if (isDevJob) {
            env.IS_PRODUCTION = 'false'
          } else if (isProdJob) {
            env.IS_PRODUCTION = 'true'
          } else {
            env.IS_PRODUCTION = (env.DEPLOY_ENV == 'production' || branch == 'main').toString()
          }
          env.ENVIRONMENT = (env.IS_PRODUCTION == 'true') ? 'production' : 'development'
          env.CONTAINER_NAME = (env.IS_PRODUCTION == 'true') ? 'frontend' : 'frontend-dev'
          env.APP_PORT = (env.IS_PRODUCTION == 'true') ? '5173' : '5174'
          env.IMAGE_NAME = 'customer-service-frontend'
          env.IMAGE_TAG = "${env.ENVIRONMENT}-${env.BUILD_NUMBER}"
          // Fijar API por Job: Develop → siempre apicsdev; Production → siempre apics (no depender de env previo)
          if (isDevJob) {
            env.VITE_API_URL = 'https://apicsdev.michelangelodelvalle.com/api'
          } else if (isProdJob) {
            env.VITE_API_URL = 'https://apics.michelangelodelvalle.com/api'
          } else {
            env.VITE_API_URL = (branch == 'main') ? 'https://apics.michelangelodelvalle.com/api' : (env.VITE_API_URL_DEV ?: 'https://apicsdev.michelangelodelvalle.com/api')
          }
          echo "========== CONFIGURACIÓN FRONTEND =========="
          echo "Job: ${env.JOB_NAME} | Rama: ${branch}"
          echo "Ambiente: ${env.ENVIRONMENT} | API: ${env.VITE_API_URL}"
          echo "============================================="
        }
      }
    }

    stage('Install') {
      steps {
        dir('frontend') {
          sh '''#!/bin/bash
            set -e
            mkdir -p "${WORKSPACE}/.nvm"
            export NVM_DIR="${WORKSPACE}/.nvm"
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
            [ -s "$NVM_DIR/nvm.sh" ] && \\. "$NVM_DIR/nvm.sh"
            nvm install 20
            nvm use 20
            npm ci
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('frontend') {
          script {
            echo "Build Docker con VITE_API_URL=${env.VITE_API_URL}"
            // Construir comando en Groovy para que el build-arg llegue bien a Docker (evitar que el shell pierda la URL)
            def buildArg = "VITE_API_URL=${env.VITE_API_URL}"
            sh "docker build --no-cache -t ${env.IMAGE_NAME}:${env.IMAGE_TAG} --build-arg \"${buildArg}\" ."
          }
        }
      }
    }

    stage('Deploy') {
      steps {
        script {
          sh "docker stop ${env.CONTAINER_NAME} 2>/dev/null || true"
          sh "docker rm ${env.CONTAINER_NAME} 2>/dev/null || true"
          sh """
            docker run -d \
              --name ${env.CONTAINER_NAME} \
              -p ${env.APP_PORT}:80 \
              --restart unless-stopped \
              ${env.IMAGE_NAME}:${env.IMAGE_TAG}
          """
        }
      }
    }
  }

  post {
    success {
      echo "Frontend desplegado (${env.ENVIRONMENT}) en http://localhost:${env.APP_PORT}"
    }
    always {
      cleanWs()
    }
  }
}
